---
export const prerender = false;

import PlotFigure from "../../components/PlotFigure.astro";
import * as Plot from "@observablehq/plot";

export function getStaticPaths() {
  return [
    { params: { species: "Adelie" } },
    { params: { species: "Gentoo" } },
    { params: { species: "Chinstrap" } },
  ];
}

const { species } = Astro.params;


const response = await fetch(`${Astro.url.origin}/api/penguins.json`);
const penguins = await response.json();

const filteredPenguins = penguins.filter((p) => p.species === species);

if (filteredPenguins.length === 0) {
  return Astro.redirect('/404');
}

const timestamp = new Date().toLocaleString('fr-FR');

const plotOptions = {
  grid: true,
  marks: [
    Plot.dot(filteredPenguins, {
      x: "flipper_length_mm",
      y: "body_mass_g",
      fill: "steelblue",
      r: 5,
      fillOpacity: 0.7,
    }),
  ],
  x: {
    label: "Longueur de la nageoire (mm)",
  },
  y: {
    label: "Masse corporelle (g)",
  },
  marginLeft: 60,
  marginBottom: 40,
  title: `Relation Masse vs Longueur de nageoire - ${species}`,
};
---

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manchots - {species} (Dynamique)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #2c5aa0;
      text-decoration: none;
      font-weight: bold;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .info-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 10px 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    .timestamp {
      background: #d1ecf1;
      border-left: 4px solid #0c5460;
      padding: 10px 15px;
      margin-bottom: 20px;
      border-radius: 4px;
      font-family: monospace;
    }
    .stats {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <a href="/" class="back-link">← Retour à l'index</a>
  
  <div class="info-box">
    <strong>Mode dynamique SSR :</strong> Cette page fetch les données à chaque requête via l'API
  </div>

  <div class="timestamp">
    <strong>Page générée le :</strong> {timestamp}
    <br>
    <small>(Rafraîchis la page pour voir le timestamp changer)</small>
  </div>
  
  <h1>Manchots de l'espèce {species}</h1>
  
  <div class="stats">
    <p><strong>{filteredPenguins.length}</strong> manchot(s) trouvé(s) pour l'espèce <strong>{species}</strong></p>
  </div>
  
  <div class="chart-container">
    <PlotFigure options={plotOptions} />
  </div>
</body>
</html>
